<h2 mat-dialog-title>{{ data ? 'Edit Matcher' : 'New Matcher' }}</h2>

<mat-dialog-content [class.loading]="loading()">
    @if (loading()) {
    <div class="loading-overlay">
        <mat-spinner diameter="40"></mat-spinner>
    </div>
    }

    <div class="dialog-content-wrapper" [class.split-view]="!!data?.transaction">
        <!-- Transaction Context (Split View Only) -->
        @if (data?.transaction; as t) {
        <div class="transaction-context">
            <h3>Target Transaction</h3>
            <div class="detail-item">
                <span class="label">Date</span>
                <span class="value">{{ t.date | date:'mediumDate' }}</span>
            </div>
            <div class="detail-item">
                <span class="label">Description</span>
                <span class="value">{{ t.description }}</span>
            </div>
            @if (t.partnerName) {
            <div class="detail-item">
                <span class="label">Partner Name</span>
                <span class="value">{{ t.partnerName }}</span>
            </div>
            }
            @if (t.partnerAccount) {
            <div class="detail-item">
                <span class="label">Partner Account</span>
                <span class="value">{{ t.partnerAccount }}</span>
            </div>
            }
            <div class="detail-item">
                <span class="label">Amount</span>
                <span class="value amount" [class.negative]="(t.movements[0].amount || 0) < 0">
                    {{ t.movements[0].amount }}
                </span>
            </div>
        </div>
        }

        <form [formGroup]="form" class="edit-form">
            <!-- General Section -->
            <h3 class="section-title">General</h3>


            <!-- Conditions Section -->
            <h3 class="section-title">Conditions</h3>

            <div class="regex-test-container">
                <mat-form-field appearance="outline" class="regex-input">
                    <mat-label>Description RegExp</mat-label>
                    <input matInput formControlName="descriptionRegExp" placeholder="^UBER.*">
                </mat-form-field>

                <div class="regex-options">
                    <mat-checkbox [checked]="isCaseInsensitive" (change)="toggleCaseInsensitive($event.checked)"
                        color="primary">
                        Case Insensitive (starts with (?i))
                    </mat-checkbox>
                    <mat-checkbox [checked]="isWholeWord" (change)="toggleWholeWord($event.checked)" color="primary">
                        Whole Words Only (wrapped in \b)
                    </mat-checkbox>
                </div>

                <!-- Regexp Tester / Match Checker -->
                <div class="regexp-tester">
                    <h3>{{ data?.transaction ? 'Match Verification' : 'Regexp Tester' }}</h3>

                    <div class="tester-controls">
                        @if (data?.transaction) {
                        <!-- Read-only display/indicator for transaction mode -->
                        <div class="test-string-display">
                            Using transaction details for verification
                        </div>
                        <button mat-stroked-button color="primary" (click)="checkMatch()"
                            [disabled]="testingMatch() || !form.controls.descriptionRegExp.value" class="test-button">
                            @if (testingMatch()) {
                            <mat-spinner diameter="20"></mat-spinner>
                            } @else {
                            <mat-icon>fact_check</mat-icon>
                            }
                            Check Match
                        </button>
                        } @else {
                        <!-- Standard manual tester -->
                        <mat-form-field appearance="outline" class="test-string-input">
                            <mat-label>Test String</mat-label>
                            <input matInput [ngModel]="testString()" (ngModelChange)="testString.set($event)"
                                [ngModelOptions]="{standalone: true}">
                        </mat-form-field>
                        <button mat-stroked-button color="accent" (click)="testRegex()"
                            [disabled]="testingMatch() || !testString() || !form.controls.descriptionRegExp.value"
                            class="test-button">
                            @if (testingMatch()) {
                            <mat-spinner diameter="20"></mat-spinner>
                            } @else {
                            <mat-icon>play_arrow</mat-icon>
                            }
                            Test
                        </button>
                        }
                    </div>

                    <!-- Results Area -->
                    @if (data?.transaction) {
                    @if (matchResult()) {
                    <div class="test-result">
                        @if (matchResult()?.result) {
                        <span class="match"><mat-icon>check_circle</mat-icon> Matches!</span>
                        <div class="match-details" *ngIf="matchResult()?.reason">
                            {{ matchResult()?.reason }}
                        </div>
                        } @else {
                        <span class="no-match"><mat-icon>cancel</mat-icon> No Match</span>
                        <div class="error-details" *ngIf="matchResult()?.reason">
                            Reason: {{ matchResult()?.reason }}
                        </div>
                        }
                    </div>
                    }
                    } @else {
                    @if (regexResult()) {
                    <div class="test-result">
                        @if (!regexResult()?.isValid) {
                        <span class="error"><mat-icon>error</mat-icon> Invalid: {{regexResult()?.error}}</span>
                        }
                        @if (regexResult()?.isValid) {
                        @if (regexResult()?.isMatch) {
                        <span class="match"><mat-icon>check_circle</mat-icon> Match</span>
                        } @else {
                        <span class="no-match"><mat-icon>cancel</mat-icon> No Match</span>
                        }
                        }
                    </div>
                    }
                    }
                </div>
            </div>

            <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                    <mat-label>Partner Name RegExp</mat-label>
                    <input matInput formControlName="partnerNameRegExp">
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                    <mat-label>Partner Account RegExp</mat-label>
                    <input matInput formControlName="partnerAccountNumberRegExp">
                </mat-form-field>
            </div>

            <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                    <mat-label>Currency RegExp</mat-label>
                    <input matInput formControlName="currencyRegExp">
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                    <mat-label>Extra RegExp</mat-label>
                    <input matInput formControlName="extraRegExp">
                </mat-form-field>
            </div>

            <!-- Output Section -->
            <h3 class="section-title">Output</h3>

            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Output Account</mat-label>
                <mat-select formControlName="outputAccountId">
                    @for (account of accounts(); track account.id) {
                    <mat-option [value]="account.id">{{ account.name }}</mat-option>
                    }
                </mat-select>
                @if (form.controls.outputAccountId.hasError('required')) {
                <mat-error>Output Account is required</mat-error>
                }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Output Description</mat-label>
                <input matInput formControlName="outputDescription" placeholder="Description to apply">
                @if (form.controls.outputDescription.hasError('required')) {
                <mat-error>Output Description is required</mat-error>
                }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Output Tags</mat-label>
                <input matInput formControlName="outputTags" placeholder="Comma separated tags (e.g. food, transport)">
                <mat-hint>Separate tags with commas</mat-hint>
            </mat-form-field>

        </form>
    </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button (click)="close()">Cancel</button>
    <button mat-raised-button color="primary" (click)="save()" [disabled]="form.invalid || loading()">
        Save
    </button>
</mat-dialog-actions>