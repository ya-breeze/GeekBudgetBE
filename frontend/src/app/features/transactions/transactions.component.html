<div class="transactions-container">
  <div class="header">
    <div class="title-section">
      <h1>Transactions</h1>
      <div class="month-navigation">
        <button mat-icon-button (click)="goToPreviousMonth()" aria-label="Previous month">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <span class="current-month">{{ currentMonthDisplay() }}</span>
        <button mat-icon-button (click)="goToNextMonth()" aria-label="Next month">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      <mat-icon>add</mat-icon>
      Add Transaction
    </button>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <div class="filter-header">
      <h3>Filters</h3>
      @if (hasActiveFilters()) {
        <button mat-button color="accent" (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      }
    </div>

    <div class="filter-controls">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Filter by Accounts</mat-label>
        <mat-select [(ngModel)]="selectedAccountIds" multiple>
          @for (account of accounts(); track account.id) {
            <mat-option [value]="account.id">{{ account.name }}</mat-option>
          }
        </mat-select>
        @if (selectedAccountIds().length > 0) {
          <mat-hint>{{ selectedAccountIds().length }} account(s) selected</mat-hint>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Filter by Tags</mat-label>
        <mat-select [(ngModel)]="selectedTags" multiple>
          @for (tag of availableTags(); track tag) {
            <mat-option [value]="tag">{{ tag }}</mat-option>
          }
        </mat-select>
        @if (selectedTags().length > 0) {
          <mat-hint>{{ selectedTags().length }} tag(s) selected</mat-hint>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Search Description</mat-label>
        <input matInput [(ngModel)]="descriptionFilter" placeholder="Enter text to search..." />
        @if (descriptionFilter()) {
          <button matSuffix mat-icon-button (click)="descriptionFilter.set('')" aria-label="Clear">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>
    </div>

    @if (hasActiveFilters()) {
      <div class="filter-summary">
        <mat-chip-set>
          @if (selectedAccountIds().length > 0) {
            <mat-chip>
              Accounts: {{ selectedAccountIds().length }}
              <button matChipRemove (click)="selectedAccountIds.set([])">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          }
          @if (selectedTags().length > 0) {
            <mat-chip>
              Tags: {{ selectedTags().length }}
              <button matChipRemove (click)="selectedTags.set([])">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          }
          @if (descriptionFilter()) {
            <mat-chip>
              Description: "{{ descriptionFilter() }}"
              <button matChipRemove (click)="descriptionFilter.set('')">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          }
        </mat-chip-set>
      </div>
    }
  </div>

  @if (loading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
  } @else {
    <div class="table-container">
      <table mat-table [dataSource]="filteredTransactions()" class="transactions-table">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let transaction">{{ transaction.date | date: 'dd/MM/yyyy' }}</td>
        </ng-container>

        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let transaction">{{ transaction.description || '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="movements">
          <th mat-header-cell *matHeaderCellDef>Movements</th>
          <td mat-cell *matCellDef="let transaction">
            {{ formatMovements(transaction) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="tags">
          <th mat-header-cell *matHeaderCellDef>Tags</th>
          <td mat-cell *matCellDef="let transaction">
            @if (transaction.tags && transaction.tags.length > 0) {
              @for (tag of transaction.tags; track tag) {
                <mat-chip>{{ tag }}</mat-chip>
              }
            } @else {
              -
            }
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let transaction">
            <button mat-icon-button (click)="openEditDialog(transaction)" aria-label="Edit">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteTransaction(transaction)" aria-label="Delete">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns()"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns().length">
            @if (hasActiveFilters()) {
              No transactions match the current filters. Try adjusting your filter criteria.
            } @else {
              No transactions found. Click "Add Transaction" to create one.
            }
          </td>
        </tr>
      </table>
    </div>
  }
</div>

