<div class="suspicious-container">
    <div class="header">
        <h1>Suspicious Transactions</h1>
        <p class="subtitle">Transactions that might require your attention</p>
    </div>

    <div class="table-container mat-elevation-z8">
        @if (loading()) {
            <div class="loading-shade">
                <mat-spinner></mat-spinner>
            </div>
        }

        <table
            mat-table
            [dataSource]="sortedTransactions()"
            matSort
            (matSortChange)="onSortChange($event)"
        >
            <!-- Date Column -->
            <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
                <td mat-cell *matCellDef="let transaction">
                    {{ transaction.date | appDate: 'dd/MM/yyyy' }}
                </td>
            </ng-container>

            <!-- Movements Column -->
            <ng-container matColumnDef="movements">
                <th mat-header-cell *matHeaderCellDef>Accounts</th>
                <td mat-cell *matCellDef="let transaction">
                    <div class="accounts-cell">
                        @for (account of getTargetAccountList(transaction); track account.id) {
                            <app-account-display
                                [name]="account.name"
                                [image]="account.image"
                                size="small"
                            />
                        }
                    </div>
                </td>
            </ng-container>

            <!-- Description Column -->
            <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Description</th>
                <td mat-cell *matCellDef="let transaction">{{ transaction.description }}</td>
            </ng-container>

            <!-- Amount Column -->
            <ng-container matColumnDef="effectiveAmount">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
                <td mat-cell *matCellDef="let transaction">
                    {{ formatEffectiveAmounts(transaction) }}
                </td>
            </ng-container>

            <!-- Suspicious Reasons Column -->
            <ng-container matColumnDef="suspiciousReasons">
                <th mat-header-cell *matHeaderCellDef>Reasons</th>
                <td mat-cell *matCellDef="let transaction">
                    <div class="reasons-list">
                        @for (reason of transaction.suspiciousReasons; track reason) {
                            <mat-chip-set>
                                <mat-chip class="suspicious-chip" highlighted color="warn">
                                    <mat-icon matChipAvatar>warning</mat-icon>
                                    {{ reason }}
                                </mat-chip>
                            </mat-chip-set>
                        }
                    </div>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let transaction">
                    @if (transaction.duplicateTransactionIds?.length) {
                        <button
                            mat-icon-button
                            (click)="openDuplicateComparison(transaction)"
                            matTooltip="Compare Duplicates"
                            color="accent"
                        >
                            <mat-icon>compare_arrows</mat-icon>
                        </button>
                    }
                    <button mat-icon-button (click)="openEditDialog(transaction)" matTooltip="Edit">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button
                        mat-icon-button
                        color="warn"
                        (click)="deleteTransaction(transaction)"
                        [disabled]="isImported(transaction)"
                        [matTooltip]="
                            isImported(transaction)
                                ? 'Imported transactions cannot be deleted'
                                : 'Delete'
                        "
                    >
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns()"></tr>

            <!-- Row shown when there is no data -->
            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns().length">
                    @if (!loading()) {
                        <div class="empty-state">
                            <mat-icon>verified_user</mat-icon>
                            <p>No suspicious transactions found. Your accounts are looking good!</p>
                        </div>
                    }
                </td>
            </tr>
        </table>
    </div>
</div>
