<h2 mat-dialog-title>{{ isEditMode ? 'Edit Bank Importer' : 'Create Bank Importer' }}</h2>
@if (isEditMode) {
    <mat-dialog-content>
        <mat-tab-group>
            <mat-tab label="Settings">
                <div class="tab-content">
                    <ng-container *ngTemplateOutlet="formContent"></ng-container>
                </div>
            </mat-tab>
            <mat-tab label="Import History">
                <div class="tab-content">
                    @if (bankImporter?.lastImports?.length) {
                        <table
                            mat-table
                            [dataSource]="bankImporter?.lastImports || []"
                            class="history-table"
                        >
                            <ng-container matColumnDef="date">
                                <th mat-header-cell *matHeaderCellDef>Date</th>
                                <td mat-cell *matCellDef="let element">
                                    {{ element.date | date: 'short' }}
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef>Status</th>
                                <td mat-cell *matCellDef="let element">
                                    <span
                                        [class.success]="element.status === 'success'"
                                        [class.error]="element.status === 'error'"
                                    >
                                        {{ element.status }}
                                    </span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="description">
                                <th mat-header-cell *matHeaderCellDef>Description</th>
                                <td mat-cell *matCellDef="let element">
                                    {{ element.description }}
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: historyColumns"></tr>
                        </table>
                    } @else {
                        <p class="no-data">No import history available.</p>
                    }
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-dialog-content>
} @else {
    <mat-dialog-content>
        <ng-container *ngTemplateOutlet="formContent"></ng-container>
    </mat-dialog-content>
}

<ng-template #formContent>
    <form [formGroup]="form" class="bank-importer-form">
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Name</mat-label>
            <input matInput formControlName="name" placeholder="e.g., My FIO Account" required />
            @if (form.get('name')?.hasError('required')) {
                <mat-error>Name is required</mat-error>
            }
            @if (form.get('name')?.hasError('maxlength')) {
                <mat-error>Name must be at most 100 characters</mat-error>
            }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Bank Type</mat-label>
            <mat-select formControlName="type" required>
                @for (type of bankTypes; track type.value) {
                    <mat-option [value]="type.value">{{ type.label }}</mat-option>
                }
            </mat-select>
            @if (form.get('type')?.hasError('required')) {
                <mat-error>Type is required</mat-error>
            }
        </mat-form-field>

        <app-account-select
            formControlName="accountId"
            label="Account"
            [required]="true"
        ></app-account-select>

        <app-account-select
            formControlName="feeAccountId"
            label="Fee Account (Optional)"
            [required]="false"
        ></app-account-select>

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea
                matInput
                formControlName="description"
                placeholder="Optional description"
                rows="3"
            ></textarea>
            @if (form.get('description')?.hasError('maxlength')) {
                <mat-error>Description must be at most 500 characters</mat-error>
            }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Extra Data</mat-label>
            <textarea
                matInput
                formControlName="extra"
                placeholder="Optional extra data (e.g., API token, account number)"
                rows="2"
            ></textarea>
        </mat-form-field>

        <div class="checkbox-field">
            <mat-checkbox formControlName="fetchAll">
                Fetch all transactions (not just recent)
            </mat-checkbox>
        </div>
    </form>
</ng-template>

<mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()">Cancel</button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="!form.valid">
        {{ isEditMode ? 'Update' : 'Create' }}
    </button>
</mat-dialog-actions>
