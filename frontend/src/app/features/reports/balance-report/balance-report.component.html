<div class="balance-report-container">
    <h1>Balance Report</h1>
    <p class="subtitle">Track account balances and net worth over time</p>

    <!-- Filter Section -->
    <mat-card class="filter-card">
        <mat-card-content>
            <form [formGroup]="filterForm" (ngSubmit)="onFilterSubmit()" class="filter-form">
                <div class="filter-fields">
                    <mat-form-field appearance="outline">
                        <mat-label>Start Date</mat-label>
                        <input matInput [matDatepicker]="startPicker" formControlName="startDate" required />
                        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                        <mat-datepicker #startPicker></mat-datepicker>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>End Date</mat-label>
                        <input matInput [matDatepicker]="endPicker" formControlName="endDate" required />
                        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                        <mat-datepicker #endPicker></mat-datepicker>
                    </mat-form-field>

                    <mat-slide-toggle [checked]="includeHidden()" (change)="onIncludeHiddenToggle()" color="primary"
                        style="margin-right: 16px; align-self: center">
                        Include Hidden
                    </mat-slide-toggle>

                    <button mat-raised-button color="primary" type="submit" [disabled]="!filterForm.valid || loading()">
                        <mat-icon>search</mat-icon>
                        Generate Report
                    </button>
                </div>
            </form>
        </mat-card-content>
    </mat-card>

    @if (loading()) {
    <div class="loading-container">
        <mat-spinner></mat-spinner>
    </div>
    } @else if (currencyReports().length) {
    @for (report of currencyReports(); track report.currencyId) {
    <h2 class="currency-title">
        Currency: {{ report.currencyName }}
        <mat-button-toggle class="currency-toggle" [checked]="selectedOutputCurrencyId() === report.currencyId"
            (click)="onOutputCurrencyToggle(report.currencyId)">
            Use as output currency
        </mat-button-toggle>
    </h2>

    <!-- Charts Section -->
    <div class="charts-section">
        <mat-card class="chart-card">
            <mat-card-header>
                <mat-card-title>Asset Balance Over Time (Stacked)</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas baseChart [data]="report.chartData" [options]="chartOptions" type="line"></canvas>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Table Section -->
    <mat-card class="summary-card">
        <mat-card-header>
            <mat-card-title>Monthly Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div class="table-container">
                <table mat-table [dataSource]="report.tableDataSource" class="summary-table">
                    <ng-container matColumnDef="account">
                        <th mat-header-cell *matHeaderCellDef>Account</th>
                        <td mat-cell *matCellDef="let row" [class.total-label]="row.account === 'Total Assets'">
                            {{ row.account }}
                        </td>
                    </ng-container>

                    @for (interval of report.intervals; track interval) {
                    <ng-container [matColumnDef]="interval">
                        <th mat-header-cell *matHeaderCellDef class="amount-cell">
                            {{ formatMonth(interval) }}
                        </th>
                        <td mat-cell *matCellDef="let row" class="amount-cell"
                            [class.total-row-cell]="row.account === 'Total Assets'">
                            {{ row[interval] | number: '1.2-2' }}
                        </td>
                    </ng-container>
                    }

                    <ng-container matColumnDef="total">
                        <th mat-header-cell *matHeaderCellDef class="amount-cell total-label">
                            Total
                        </th>
                        <td mat-cell *matCellDef="let row" class="amount-cell total-amount">
                            {{ row.total | number: '1.2-2' }}
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="report.tableColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: report.tableColumns"
                        [class.total-row]="row.account === 'Total Assets'"></tr>
                </table>
            </div>
        </mat-card-content>
    </mat-card>
    }
    } @else {
    <mat-card class="no-data-card">
        <mat-card-content>
            <p>
                No balance data available. Please select a date range and generate the report.
            </p>
        </mat-card-content>
    </mat-card>
    }
</div>